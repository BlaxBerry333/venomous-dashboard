# i18n 开发文档

Dashboard 中使用了 i18n 来实现多语言国际化的支持

## 处理流程

```
  【 用户请求 URL 】
──────────────────────────────────────
比如：/zh-CN/dashboard
──────────────────────────────────────
          │
          ▼
  【 Next.js 中间件 】
──────────────────────────────────────
1. 对 URL 中的 locale 进行解析、拼接、重定向
2. 拼接 locale 到请求路径
──────────────────────────────────────
          │
          ▼
  【 Next.js 服务端 】
──────────────────────────────────────
1. <RootLayout> 根据请求 params.locale 调用 getDictionary(locale, namespaces)
2. 服务端根据 locales、namespaces 读取对应的翻译文件并整合为翻译字典对象后返回
3. 通过 <I18nProvider> 将 i18n 翻译字典传递给作为子组件的客户端组件
──────────────────────────────────────
          │
          ▼
  【 Next.js 客户端 】
──────────────────────────────────────
1. 客户端组件通过 Hook 函数 useI18nDictionary() 获取当前语言的 i18n 翻译字典
2. 通过链式调用 字典.命名空间.key 来获取翻译文本
──────────────────────────────────────
```

## 核心文件概览

```shell
dashboard/
└── src/
  ├── middlewares/
  │   └── i18n.middleware.ts          # 解析 URL 以及拼接语言到请求路径
  │
  └── utils/
    └── i18n/
      ├── constants/                  # i18n 相关的常量和选项
      │   └── index.ts
      │
      ├── hooks/
      │   ├── useI18nLocale.ts        # 用于在服务端组件访问当前语言
      │   └── useI18nDictionary.ts    # 用于在客户端组件访问翻译字典
      │
      ├── locales/
      │   └── <locale>
      │       ├── <namespace>.json    # 语言对应的命名空间下的翻译文件
      │       └── ...
      │
      ├── provider/
      │   └── I18nProvider.tsx        # 用于包裹应用，在服务端将翻译字典注入到客户端
      │
      ├── types/
      │   └── index.ts                # 基于 config.ts 的类型
      │
      ├── config.ts                   # i18n 配置，定义了所有支持的语言和命名空间
      │
      ├── dictionaries.ts             # 用于整合翻译文件，提供在服务端组件可以访问的翻译字典
      │
      ├── index.client.ts             # 供客户端导入使用的入口
      └── index.server.ts             # 供服务端导入使用的入口
```

## 配置

```ts
export const i18n = {
  // 当无法从 URL 中确定语言时使用的默认语言
  defaultLocale: "en",
  // 受支持语言代码的数组
  locales: ["en", "zh-CN"] as const,
  // 代码分割和按需加载的翻译文件命名空间
  namespaces: ["common", "navbar", "workflow"] as const,
} as const;
```

## 语言 ( Locale )

语言是一个 BCP 47 标准的字符串，用于标识当前应用的语言环境

目前的设计是将语言拼接在 URL 的最前面，例如：`/<locale>/<route>/<route>/`

定义在配置文件`@/utils/i18n/config.ts`

---

### 获取语言

- 服务端组件可以通过组件的 `props.params.locale` 获取
- 客户端组件可以通过 `useParams()` 或 `useI18nLocale()` 获取

---

### 追加语言

在 `@/utils/i18n/config.ts` 的 `i18n.locales` 中添加新的语言代码名称

必须遵循 BCP 47 标准 ( 例如：`en`、`zh-CN`、`zh-TW`、`ja` 等 )

---

### 语言切换

URL 中的语言只建议在两处被变更：

1. 在请求中间件`i18nLocaleMiddleware` 函数中：在访问路径时判断 URL 是否包含语言前缀，若没有则拼接
2. 在客户端组件`<LanguageSwitcher>` 中将选中的语言拼接到请求路径，然后通过 `<Link>` 组件进行跳转

## 命名空间 ( Namespace )

命名空间是一个用于更详细区分不同翻译文件的字符串，用于在翻译字典中进行区分

定义在配置文件`@/utils/i18n/config.ts`

## 翻译字典 ( Dictionary )

i18n 翻译字典是一个整合了所有支持的语言下的所有和命名空间的翻译文本的的对象

定义在配置文件`@/utils/i18n/dictionaries.ts`

> 构造如下：

```ts
const dictionaries = {
  [语言1]: {
    [命名空间1]: () =>
      import("./locales/<语言1>/<命名空间1>.json").then((m) => m.default),
    [命名空间2]: () =>
      import("./locales/<语言1>/<命名空间2>.json").then((m) => m.default),
  },
  [语言2]: {
    [命名空间1]: () =>
      import("./locales/<语言2>/<命名空间1>.json").then((m) => m.default),
    [命名空间2]: () =>
      import("./locales/<语言2>/<命名空间2>.json").then((m) => m.default),
  },
};
```

---

### 使用在服务端组件 ( Server Components )

在服务端组件中必须且只能通过函数 `getDictionary()` 来获取翻译字典

改函数是一个只能在服务端组件中使用的`server-only`的异步函数，用于从翻译文件中获取翻译字典对象。

```ts
const dictionary = await getDictionary(
  // 指明当前语言，获取自页面组件的 props.params.locale
  "当前语言",
  // 指明翻译字典加载的翻译文件来自哪些命名空间，可以限定一部分或者全部
  ["命名空间", "命名空间", "命名空间"]
);
```

> 例子：翻译字典仅加载`"common"`、`"validation"`两个命名空间下的翻译文件

```tsx
import { getDictionary } from "@/utils/i18n/index.serve";
import type { I18nLocale } from "@/utils/i18n";

interface Props {
  params: Promise<{ locale: I18nLocale }>;
}

export default async function Page({ params: { locale } }: Props) {
  const dictionary = await getDictionary(locale, ["common", "validation"]);

  return (
    <div>
      {/* 使用 validation 命名空间下的 key */}
      {dictionary.validation.required}
      {/* 使用 common 命名空间下的 key */}
      {dictionary.common.submit}
    </div>
  );
}
```

---

### 使用在客户端组件 ( Client Components )

在客户端组件中必须且只能通过钩子函数 `useI18nDictionary()` 来获取翻译字典

前提条件是该组件必须被包裹在`<I18nProvider>`组件中。

```tsx
"use client";

import { useI18nDictionary } from "@/utils/i18n";

export default function ClientComponent() {
  const dictionary = useI18nDictionary();

  return (
    <div>
      {/* 使用 common 命名空间下的 key */}
      <p>{dictionary.common.greeting}</p>
      {/* 使用 workflow 命名空间下的 key */}
      <h2>{dictionary.workflow.title}</h2>
    </div>
  );
}
```
